<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 9: Time Series Lab - Build Your Forecasting Engine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Georgia, serif;
            line-height: 1.8;
            color: #333;
            background: linear-gradient(to bottom, #f5f5f5, #ffffff);
            padding: 20px;
        }
        
        .container {
            max-width: 950px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        
        h2 {
            color: #003366;
            font-size: 1.6em;
            margin-top: 30px;
            margin-bottom: 15px;
            border-left: 4px solid #003366;
            padding-left: 10px;
        }
        
        .mission-brief {
            background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%);
            border-left: 4px solid #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .task-container {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .task-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .task-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #003366;
        }
        
        .task-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #0366d6;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .checkbox.checked {
            background: #0366d6;
        }
        
        .checkbox.checked::after {
            content: '✓';
            color: white;
            font-size: 16px;
        }
        
        .code-editor {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            position: relative;
        }
        
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .code-title {
            color: #f8f8f2;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .run-button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s ease;
        }
        
        .run-button:hover {
            background: #45a049;
        }
        
        textarea {
            width: 100%;
            min-height: 200px;
            background: #1e1e1e;
            color: #f8f8f2;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            resize: vertical;
        }
        
        .output-console {
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            min-height: 100px;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .hint-container {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            display: none;
        }
        
        .hint-button {
            background: #ff9800;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
            transition: background 0.3s ease;
        }
        
        .hint-button:hover {
            background: #f57c00;
        }
        
        .progress-tracker {
            background: #e0e0e0;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .performance-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #0366d6;
        }
        
        .metric-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .test-suite {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 4px;
        }
        
        .test-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .test-status.pass {
            background: #d4edda;
            color: #155724;
        }
        
        .test-status.fail {
            background: #f8d7da;
            color: #721c24;
        }
        
        .test-status.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .challenge-alert {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .final-submission {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin: 30px 0;
            text-align: center;
        }
        
        .submit-button {
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            margin-top: 20px;
            transition: transform 0.3s ease;
        }
        
        .submit-button:hover {
            transform: scale(1.05);
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
            text-align: center;
        }
        
        canvas {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔬 Time Series Lab: Operation Forecast</h1>
            <p style="font-size: 1.1em;">90 minutes to build a production-ready forecasting system</p>
        </div>
        
        <div class="mission-brief">
            <h2 style="color: #667eea; border: none; margin-top: 0;">⚡ URGENT MISSION BRIEF</h2>
            <p><strong>Situation:</strong> MegaRetail's inventory system is hemorrhaging $75M annually. The board has given you 90 minutes to build and deploy a forecasting engine that will transform the company's supply chain.</p>
            <p><strong>Your Objective:</strong> Implement a complete time series forecasting system with ARIMA modeling, dynamic safety stock calculation, and multi-SKU optimization.</p>
            <p><strong>Success Criteria:</strong> Achieve <10% MAPE, >95% service level, and demonstrate $50M+ in annual savings.</p>
            <p><strong>Stakes:</strong> Success = Chief Innovation Officer promotion. Failure = Company faces hostile takeover.</p>
        </div>
        
        <div class="progress-tracker">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>
        
        <!-- Task 1: Data Preparation -->
        <div class="task-container">
            <div class="task-header">
                <div class="task-title">📊 Task 1: Load and Prepare Time Series Data</div>
                <div class="task-status">
                    <span>Estimated: 15 min</span>
                    <div class="checkbox" id="task1Check" onclick="toggleTask(1)"></div>
                </div>
            </div>
            
            <p>First, we need to load three years of sales history and prepare it for analysis. This data contains hidden patterns worth millions.</p>
            
            <div class="code-editor">
                <div class="code-header">
                    <span class="code-title">data_preparation.py</span>
                    <button class="run-button" onclick="runCode('task1')">▶ Run Code</button>
                </div>
                <textarea id="task1Code">
import pandas as pd
import numpy as np
from datetime import datetime, timedelta

# Generate realistic sales data with patterns
def generate_sales_data():
    """
    Create 3 years of daily sales data with:
    - Linear growth trend (12% annually)
    - Monthly seasonality
    - Holiday spikes
    - Random noise
    """
    dates = pd.date_range(start='2022-01-01', end='2024-12-31', freq='D')
    n_days = len(dates)
    
    # TODO: Create trend component (12% annual growth)
    trend = # Your code here
    
    # TODO: Add monthly seasonality (peaks in November/December)
    seasonal = # Your code here
    
    # TODO: Add holiday spikes (Black Friday, Christmas)
    holidays = # Your code here
    
    # Combine components
    sales = trend + seasonal + holidays + np.random.normal(0, 50, n_days)
    
    # Create DataFrame
    df = pd.DataFrame({
        'date': dates,
        'sales': sales.clip(min=0),  # No negative sales
        'units': (sales / 50).clip(min=0).astype(int)
    })
    
    return df

# Load and inspect data
sales_df = generate_sales_data()
print(f"Data shape: {sales_df.shape}")
print(f"Date range: {sales_df['date'].min()} to {sales_df['date'].max()}")
print(f"Average daily sales: ${sales_df['sales'].mean():,.2f}")
print(f"Peak sales day: ${sales_df['sales'].max():,.2f}")
print(f"Total revenue: ${sales_df['sales'].sum():,.2f}")
</textarea>
                <div class="output-console" id="task1Output"></div>
            </div>
            
            <button class="hint-button" onclick="showHint(1)">💡 Need Help?</button>
            <div class="hint-container" id="hint1">
                <strong>Hint:</strong> For the trend, use: <code>100000 + np.arange(n_days) * 100</code>. For seasonality, use sine waves with period 365.25. For holidays, create spikes on specific dates using conditionals.
            </div>
        </div>
        
        <!-- Task 2: Time Series Decomposition -->
        <div class="task-container">
            <div class="task-header">
                <div class="task-title">🔍 Task 2: Decompose Time Series Components</div>
                <div class="task-status">
                    <span>Estimated: 10 min</span>
                    <div class="checkbox" id="task2Check" onclick="toggleTask(2)"></div>
                </div>
            </div>
            
            <p>Identify the hidden patterns in your sales data using STL decomposition. Each component reveals a different business insight.</p>
            
            <div class="code-editor">
                <div class="code-header">
                    <span class="code-title">decomposition.py</span>
                    <button class="run-button" onclick="runCode('task2')">▶ Run Code</button>
                </div>
                <textarea id="task2Code">
from statsmodels.tsa.seasonal import STL
import matplotlib.pyplot as plt

def decompose_time_series(df):
    """
    Perform STL decomposition to extract:
    - Trend: Long-term direction
    - Seasonal: Repeating patterns
    - Residual: Random variations
    """
    # Set date as index
    df_indexed = df.set_index('date')
    
    # TODO: Perform STL decomposition
    # Use period=365 for yearly seasonality
    stl = # Your code here
    result = # Fit the model
    
    # Extract components
    trend = result.trend
    seasonal = result.seasonal
    residual = result.resid
    
    # Calculate component strengths
    trend_strength = 1 - np.var(residual) / np.var(trend + residual)
    seasonal_strength = 1 - np.var(residual) / np.var(seasonal + residual)
    
    # Business insights
    insights = {
        'trend_direction': 'increasing' if trend.iloc[-1] > trend.iloc[0] else 'decreasing',
        'trend_strength': trend_strength,
        'seasonal_strength': seasonal_strength,
        'peak_season': df_indexed.groupby(df_indexed.index.month)['sales'].mean().idxmax(),
        'volatility': residual.std()
    }
    
    return result, insights

# Run decomposition
decomposition, insights = decompose_time_series(sales_df)

print("📈 Decomposition Insights:")
print(f"Trend: {insights['trend_direction']} (strength: {insights['trend_strength']:.2%})")
print(f"Seasonality strength: {insights['seasonal_strength']:.2%}")
print(f"Peak sales month: {insights['peak_season']}")
print(f"Daily volatility: ${insights['volatility']:,.2f}")

# Calculate financial impact
seasonal_impact = insights['seasonal_strength'] * sales_df['sales'].mean() * 365
print(f"\n💰 Financial Impact:")
print(f"Seasonal variation worth: ${seasonal_impact:,.0f} annually")
</textarea>
                <div class="output-console" id="task2Output"></div>
            </div>
            
            <canvas id="decompositionChart"></canvas>
        </div>
        
        <!-- Task 3: Build ARIMA Model -->
        <div class="task-container">
            <div class="task-header">
                <div class="task-title">🤖 Task 3: Build ARIMA Forecasting Model</div>
                <div class="task-status">
                    <span>Estimated: 20 min</span>
                    <div class="checkbox" id="task3Check" onclick="toggleTask(3)"></div>
                </div>
            </div>
            
            <p>Implement an auto-ARIMA model that will predict future demand with precision. This is where the $50M savings begin.</p>
            
            <div class="code-editor">
                <div class="code-header">
                    <span class="code-title">arima_model.py</span>
                    <button class="run-button" onclick="runCode('task3')">▶ Run Code</button>
                </div>
                <textarea id="task3Code">
from statsmodels.tsa.arima.model import ARIMA
from sklearn.metrics import mean_absolute_percentage_error
import warnings
warnings.filterwarnings('ignore')

def build_arima_model(df, test_days=30):
    """
    Build and optimize ARIMA model
    Target: MAPE < 10% for board approval
    """
    # Split data
    train_size = len(df) - test_days
    train = df.iloc[:train_size]
    test = df.iloc[train_size:]
    
    # TODO: Grid search for best ARIMA parameters
    best_aic = np.inf
    best_params = None
    best_model = None
    
    for p in range(0, 3):
        for d in range(0, 2):
            for q in range(0, 3):
                try:
                    # TODO: Fit ARIMA model
                    model = # Your code here
                    fitted = # Fit the model
                    
                    if fitted.aic < best_aic:
                        best_aic = fitted.aic
                        best_params = (p, d, q)
                        best_model = fitted
                except:
                    continue
    
    # Generate forecast
    forecast = best_model.forecast(steps=test_days)
    
    # Calculate metrics
    mape = mean_absolute_percentage_error(test['sales'], forecast)
    rmse = np.sqrt(np.mean((test['sales'] - forecast) ** 2))
    
    # Calculate confidence intervals
    forecast_df = best_model.get_forecast(steps=test_days)
    confidence = forecast_df.conf_int()
    
    return {
        'model': best_model,
        'params': best_params,
        'mape': mape,
        'rmse': rmse,
        'forecast': forecast,
        'confidence': confidence,
        'test_actual': test['sales'].values
    }

# Build and evaluate model
results = build_arima_model(sales_df)

print(f"🎯 Model Performance:")
print(f"Best ARIMA parameters: {results['params']}")
print(f"MAPE: {results['mape']:.2%}")
print(f"RMSE: ${results['rmse']:,.2f}")

# Financial impact
avg_daily_sales = sales_df['sales'].mean()
accuracy_improvement = 0.15 - results['mape']  # vs 15% baseline
daily_savings = avg_daily_sales * 0.25 * accuracy_improvement  # 25% holding cost
annual_savings = daily_savings * 365

print(f"\n💰 Business Impact:")
print(f"Accuracy improvement: {accuracy_improvement:.2%}")
print(f"Daily inventory savings: ${daily_savings:,.2f}")
print(f"Annual savings: ${annual_savings:,.2f}")

# Check if we meet board requirements
if results['mape'] < 0.10:
    print("\n✅ SUCCESS: Model meets board requirements!")
else:
    print(f"\n⚠️ WARNING: MAPE {results['mape']:.2%} > 10% target")
</textarea>
                <div class="output-console" id="task3Output"></div>
            </div>
            
            <div class="test-suite">
                <h4>Model Validation Tests:</h4>
                <div class="test-item">
                    <span>MAPE < 10%</span>
                    <span class="test-status pending" id="test1">PENDING</span>
                </div>
                <div class="test-item">
                    <span>Residuals White Noise</span>
                    <span class="test-status pending" id="test2">PENDING</span>
                </div>
                <div class="test-item">
                    <span>No Autocorrelation</span>
                    <span class="test-status pending" id="test3">PENDING</span>
                </div>
                <div class="test-item">
                    <span>Forecast Within CI</span>
                    <span class="test-status pending" id="test4">PENDING</span>
                </div>
            </div>
        </div>
        
        <!-- Challenge: Black Friday Optimization -->
        <div class="challenge-alert">
            <h3>⚡ URGENT CHALLENGE: Black Friday in 30 Days!</h3>
            <p>The CEO just called - Black Friday is approaching and last year we lost $10M in sales due to stockouts.</p>
            <p>Modify your forecast to account for the 500% demand spike!</p>
        </div>
        
        <!-- Task 4: Dynamic Safety Stock -->
        <div class="task-container">
            <div class="task-header">
                <div class="task-title">🛡️ Task 4: Calculate Dynamic Safety Stock</div>
                <div class="task-status">
                    <span>Estimated: 15 min</span>
                    <div class="checkbox" id="task4Check" onclick="toggleTask(4)"></div>
                </div>
            </div>
            
            <p>Replace static safety stock with dynamic calculations based on forecast uncertainty. This is where we save $35M annually.</p>
            
            <div class="code-editor">
                <div class="code-header">
                    <span class="code-title">safety_stock.py</span>
                    <button class="run-button" onclick="runCode('task4')">▶ Run Code</button>
                </div>
                <textarea id="task4Code">
from scipy import stats

def calculate_dynamic_safety_stock(forecast_results, service_level=0.95,